version: "3.9"

# =============================================================================
# Docker Compose - PRODUCTION (Coolify)
# - Next.js standalone (frontend)
# - Express (backend)
# - Healthchecks stables
# - Aucun port exposé (Coolify gère le proxy)
# =============================================================================

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        NODE_ENV: production

    env_file:
      - .env

    environment:
      NODE_ENV: production
      PORT: 3001

    # Healthcheck serré pour que Traefik route vite après un déploiement (Coolify)
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://localhost:3001/api/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    networks:
      - app-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
        NEXT_PUBLIC_API_URL: /api

    environment:
      NODE_ENV: production
      PORT: 3000
      HOSTNAME: 0.0.0.0
      NEXT_PUBLIC_API_URL: /api

    depends_on:
      backend:
        condition: service_healthy

    # Healthcheck serré pour que Traefik route vite après un déploiement (Coolify)
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://localhost:3000/api/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 15s

    restart: unless-stopped

    networks:
      - app-network

networks:
  app-network:
    driver: bridge
